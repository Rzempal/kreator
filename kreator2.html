<!-- kreator2.html v0.010 Auto-preview: sta≈Çy podglƒÖd ostatnio u≈ºytego rozmiaru (desktop + mobile) -->
<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kreator Paneli (Final Layout)</title>
    <style>
        :root {
            --primary: #5d3a75;
            --bg: #f4f6f9;
            --text: #333;
            --border: #ccc;
            --active-border: #28a745;
            --toolbar-bg: #fff;
            --danger: #dc3545;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            padding: 20px;
            max-width: 1600px;
            margin: 0 auto;
            height: 95vh;
            box-sizing: border-box;
        }

        .layout {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            height: 100%;
        }

        /* --- LEWA KOLUMNA (KONFIGURACJA) --- */
        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            height: 100%;
            overflow-y: auto;
            padding-right: 5px;
        }

        .card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        h3 { margin-top: 0; font-size: 1.1em; border-bottom: 2px solid #f0f0f0; padding-bottom: 8px; margin-bottom: 12px; color: #444; }
        label { display: block; font-size: 0.85em; font-weight: 600; color: #555; margin-bottom: 4px; }
        input[type="number"], select { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; box-sizing: border-box; }

        /* Przyciski */
        button { cursor: pointer; transition: 0.2s; }
        .btn-secondary { background: #e2e6ea; color: #333; border: 1px solid #ced4da; padding: 6px 12px; border-radius: 4px; font-size: 0.9em; }
        .btn-secondary:hover { background: #dbe2e8; }
        .btn-danger { background: #fff5f5; color: var(--danger); border: 1px solid #f5c6cb; padding: 8px; border-radius: 4px; width: 100%; margin-top: 10px;}
        .btn-danger:hover { background: #f8d7da; }
        .btn-add-segment { width: 100%; background: #e9ecef; border: 1px solid #ced4da; color: #333; padding: 8px; border-radius: 4px; margin-top: 5px; font-weight: bold;}

        /* Lista Odcink√≥w */
        .segment-row { display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #fafafa; border-bottom: 1px solid #eee; font-size: 0.9em; }
        .segment-icon { font-size: 1.2em; margin-right: 8px; color: #999; }
        .btn-x { padding: 2px 8px; font-size: 0.8em; color: var(--danger); border: 1px solid var(--danger); background: #fff; border-radius: 4px; }

        /* Lista Wariant√≥w (Config) */
        .variant-config-list { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px; }
        .variant-tag { background: #eee; padding: 4px 8px; border-radius: 12px; font-size: 0.85em; display: flex; align-items: center; gap: 5px; }
        .variant-tag span { cursor: pointer; color: #999; font-weight: bold; }
        .variant-tag span:hover { color: var(--danger); }

        /* Mapowanie */
        .mapping-item { background: #fcfcfc; border: 1px solid #eee; padding: 8px; margin-bottom: 5px; border-radius: 4px; display: flex; gap: 10px; align-items: center; }
        .map-swatch { width: 24px; height: 24px; border-radius: 50%; border: 1px solid #ccc; flex-shrink: 0; }
        .map-select { font-size: 0.85em; padding: 4px; }

        /* Podsumowanie */
        .price-summary { background: #e8f5e9; border: 1px solid #c8e6c9; padding: 10px; border-radius: 6px; margin-top: 10px; }
        .total-price { font-size: 1.4em; font-weight: bold; color: #2e7d32; text-align: right; }

        /* --- PRAWA STRONA (PROJEKT) --- */
        .project-area {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
            border: 1px solid #ddd;
        }

        /* TOP BAR */
        .top-bar {
            background: var(--toolbar-bg);
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            min-height: 50px;
        }
        .top-bar-title { font-size: 0.8em; font-weight: bold; color: #888; text-transform: uppercase; margin-right: 5px; }
        .panel-btn {
            background: #fff; border: 1px solid #ccc; padding: 8px 15px; border-radius: 4px;
            font-weight: bold; color: #333; font-size: 0.95em; display: flex; align-items: center; gap: 5px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .panel-btn:hover { background: #f0f2f5; border-color: #aaa; transform: translateY(-1px); }
        .panel-btn span { font-size: 0.8em; font-weight: normal; color: #666; }

        .mode-toggle {
            background: var(--primary); color: white; border: 2px solid var(--primary);
            padding: 8px 15px; border-radius: 4px; font-weight: bold; font-size: 0.9em;
            margin-left: auto;
        }
        .mode-toggle:hover { background: #4a2e5e; border-color: #4a2e5e; }

        /* WORKSPACE */
        .workspace {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
            position: relative;
        }

        /* LEFT VERTICAL BAR (TOOLS) */
        .tools-bar {
            width: 60px;
            background: #fcfcfc;
            border-right: 1px solid #eee;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px 5px;
            gap: 10px;
            overflow-y: auto;
            z-index: 2;
        }

        .tool-btn {
            width: 40px; height: 40px; border-radius: 50%;
            border: 2px solid #ddd; cursor: pointer; position: relative; flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.1s;
            background-size: cover; background-position: center;
        }
        .tool-btn:hover { transform: scale(1.1); z-index: 3; }
        .tool-btn.active { border-color: var(--active-border); transform: scale(1.1); box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.2); }
        .tool-btn.eraser {
            background: #fff url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="%23d32f2f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>') no-repeat center;
            border-color: #f5c6cb;
        }
        .tool-btn.eraser.active { background-color: #ffecec; border-color: #dc3545; box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.2); }

        .tool-sep { width: 60%; height: 1px; background: #ddd; margin: 5px 0; }

        /* CANVAS */
        .canvas-wrapper {
            flex-grow: 1;
            background: #eef1f5;
            overflow: auto;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        svg { display: block; background: #f8f9fa; box-shadow: 0 5px 25px rgba(0,0,0,0.05); }

        .wall-bg { fill: #e0e0e0; stroke: #777; stroke-width: 2; }
        .panel-rect { stroke: rgba(255,255,255,0.3); stroke-width: 2; cursor: crosshair; transition: fill-opacity 0.1s; }
        .panel-rect.delete-mode { cursor: not-allowed; }
        .panel-rect:hover { stroke: #666; stroke-width: 3px; filter: brightness(1.1); }
        .dim-text-panel { font-size: 14px; font-family: Arial, sans-serif; fill: white; font-weight: bold; text-shadow: 0 0 3px rgba(0,0,0,0.8); pointer-events: none; }
        .dim-text-external { font-size: 11px; font-family: Arial, sans-serif; fill: #444; font-weight: normal; }
        .dim-line { stroke: #444; stroke-width: 1; stroke-dasharray: 2,2; }

        .canvas-zoom {
            position: absolute; bottom: 20px; right: 20px;
            background: rgba(255,255,255,0.9); padding: 5px 10px; border-radius: 20px;
            display: flex; gap: 5px; border: 1px solid #ccc; align-items: center;
            font-size: 0.85em; font-weight: bold; color: #555;
        }

        /* Zapis */
        .save-slot { background: #f8f9fa; border: 1px solid #eee; padding: 8px; margin-bottom: 5px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; font-size: 0.85em; }

        @media (max-width: 900px) {
            .layout { grid-template-columns: 1fr; height: auto; display: block; }
            .controls { height: auto; margin-bottom: 20px; overflow: visible; }
            .project-area { height: 600px; }
        }
    </style>
</head>
<body>

<div class="layout">

    <!-- 1. LEWA KOLUMNA (KONFIGURACJA) -->
    <div class="controls">

        <!-- Kszta≈Çt obszaru roboczego -->
        <div class="card">
            <h3>1. Kszta≈Çt obszaru roboczego</h3>
            <div id="segmentsContainer"></div>

            <div style="background:#fdfdfd; padding:10px; border:1px dashed #ccc; margin-top:10px; border-radius:4px;">
                <div class="row-inputs" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px;">
                    <input type="number" id="segWidth" placeholder="Szer.">
                    <input type="number" id="segStartHeight" placeholder="np. 140">
                    <input type="number" id="segEndHeight" placeholder="Wys. ko≈Ñc.">
                </div>
                <button class="btn-add-segment" onclick="addSegment()">+ Dodaj Segment</button>
            </div>
            <button class="btn-secondary" style="width:100%; margin-top:10px; background:#e8f5e9; border-color:#81c784; color:#2e7d32;" onclick="loadPresetWorkspace()">üìã Wczytaj przyk≈Çad</button>
            <button class="btn-danger" onclick="resetWall()">Resetuj Obszar</button>
        </div>

        <!-- Konfiguracja Paneli -->
        <div class="card">
            <h3>2. Konfiguracja Paneli</h3>
            <p style="font-size:0.8em; color:#666; margin-bottom:5px;">Zdefiniuj wymiary paneli (szer √ó wys) dostƒôpne do uk≈Çadania.</p>
            <div class="row-inputs" style="display:grid; grid-template-columns:1fr 1fr auto; gap:5px;">
                <input type="number" id="newVariantWidth" placeholder="Szer.">
                <input type="number" id="newVariantHeight" placeholder="Wys.">
                <button class="btn-secondary" onclick="addVariantDefinition()">Dodaj</button>
            </div>
            <div id="variantConfigList" class="variant-config-list"></div>
        </div>

        <!-- Wycena i Mapowanie -->
        <div class="card" style="border-left: 5px solid #28a745;">
            <h3>3. Wycena i Materia≈Çy</h3>

            <div id="mappingContainer" style="margin-bottom:15px;"></div>

            <div style="font-size:0.9em; margin-bottom:10px; display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                <label style="font-weight:normal;"><input type="checkbox" id="optFoam" onchange="recalculatePrice()"> Podw√≥jna pianka</label>
                <label style="font-weight:normal;"><input type="checkbox" id="optVelcro" onchange="recalculatePrice()"> Rzep monta≈ºowy</label>
                <label style="font-weight:normal;"><input type="checkbox" id="optShipping" checked onchange="recalculatePrice()"> Wysy≈Çka</label>
            </div>
            <div class="form-group">
                <label>Klej (szt):</label>
                <input type="number" id="optGlue" value="0" onchange="recalculatePrice()">
            </div>

            <div class="price-summary">
                <div class="total-price" id="totalPriceDisplay">0.00 z≈Ç</div>
                <div style="font-size:0.8em; color:#555; margin-top:5px;" id="priceDetails"></div>
            </div>
        </div>

        <!-- Zapis -->
        <div class="card">
            <h3>Zapisane Projekty</h3>
            <button class="btn-secondary" style="width:100%; margin-bottom:10px; background:#e3f2fd; border-color:#90caf9; color:#1565c0;" onclick="saveCurrentLayout()">üíæ Zapisz obecny uk≈Çad</button>
            <div id="savesContainer"></div>
        </div>

    </div>

    <!-- 2. PRAWA STRONA (PROJEKT) -->
    <div class="project-area">

        <!-- TOP BAR: SZYBKIE DODAWANIE -->
        <div class="top-bar" id="topBar">
            <div class="top-bar-title">Dodaj Panel:</div>
            <div id="topVariantsButtons" style="display:flex; gap:8px; overflow-x:auto;"></div>
            <button class="mode-toggle" id="modeToggleBtn" onclick="toggleLayoutMode()">‚û° Dodaj poziomo</button>
        </div>

        <!-- WORKSPACE -->
        <div class="workspace">
            <!-- LEFT BAR: NARZƒòDZIA -->
            <div class="tools-bar" id="toolsBar">
                <!-- Generowane JS (Kolory + Gumka) -->
            </div>

            <!-- CANVAS -->
            <div class="canvas-wrapper">
                <div id="svgWrapper"></div>

                <div class="canvas-zoom">
                    <button onclick="changeZoom(-0.1)" class="btn-secondary" style="padding:2px 6px;">-</button>
                    <span id="zoomLabel">100%</span>
                    <button onclick="changeZoom(0.1)" class="btn-secondary" style="padding:2px 6px;">+</button>
                    <span style="color:#ccc">|</span>
                    <button onclick="undoPanel()" class="btn-secondary" title="Cofnij" style="padding:2px 6px;">‚Ü©</button>
                </div>
            </div>
        </div>
    </div>

</div>

<script src="references/rozmiary.js"></script>
<script>
    // --- DANE ---
    const Collections = {
        Standard: ['DIANA', 'LUNA', 'SWEET', 'TANGO', 'NUBUK', 'TREND', 'OLIMP', 'TRINITY'],
        Premium: ['KRONOS', 'RODOS', 'FOREST', 'CROWN', 'MONOLITH', 'EVO', 'FRESH', 'PRESTON'],
        Exclusive: ['VELVET', 'ALCANTARA', 'LOFT', 'JAZZ']
    };

    // Paleta wizualna
    const visualPalette = [
        { hex: '#5d3a75', name: 'Fiolet' }, { hex: '#8e8e93', name: 'Szary' },
        { hex: '#d2b48c', name: 'Be≈º' }, { hex: '#1a2a6c', name: 'Granat' },
        { hex: '#2d5a27', name: 'Ziele≈Ñ' }, { hex: '#e6bece', name: 'Pudrowy' },
        { hex: '#d4af37', name: '≈ª√≥≈Çty' }, { hex: '#333333', name: 'Grafit' }
    ];
    // Dekor (Base64)
    const floralTex = "data:image/svg+xml,%3Csvg width='50' height='50' viewBox='0 0 50 50' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='50' height='50' fill='%236a4c93'/%3E%3Ccircle cx='25' cy='25' r='10' fill='%23ffffff' opacity='0.2'/%3E%3Cpath d='M25 15 L35 25 L25 35 L15 25 Z' fill='%23ffffff' opacity='0.2'/%3E%3C/svg%3E";
    const visualTextures = [{ file: floralTex, name: 'Dekor' }];

    // --- STAN ---
    let wallData = { segments: [] };
    let variants = [
        {width: 30, height: 100},
        {width: 20, height: 140},
        {width: 30, height: 40}
    ]; // Domy≈õlne wymiary
    let panels = []; // {width, height, x, y, style}
    let activeTool = { type: 'color', value: visualPalette[0].hex }; // 'eraser' lub {type, value}
    let styleMapping = {};
    let layoutMode = 'horizontal'; // 'horizontal' | 'vertical'
    let zoomLevel = 1.0;
    let selectedPanelSize = null; // {width, height} - wybrany panel do dodania (hover)
    let lastUsedPanelSize = null; // {width, height} - ostatnio dodany panel (auto-preview)
    const STORAGE_KEY = 'panelConfig_V6_Saves';

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => {
        renderSegmentsList();
        renderVariantConfig(); // Lewy panel (konfiguracja)
        renderTopBar();        // G√≥rny pasek (u≈ºycie)
        renderToolsBar();      // Pasek narzƒôdzi
        renderSaves();
        draw();
        updateMappingUI();
    });

    // --- 1. ZARZƒÑDZANIE WARIANTAMI (SEKCJA 2 + TOP BAR) ---
    function addVariantDefinition() {
        const w = parseFloat(document.getElementById('newVariantWidth').value);
        const h = parseFloat(document.getElementById('newVariantHeight').value);

        if (w > 0 && h > 0) {
            const exists = variants.some(v => v.width === w && v.height === h);
            if (!exists) {
                variants.push({width: w, height: h});
                variants.sort((a,b) => (b.width * b.height) - (a.width * a.height));
                renderVariantConfig();
                renderTopBar();
                document.getElementById('newVariantWidth').value = '';
                document.getElementById('newVariantHeight').value = '';
            }
        }
    }

    function removeVariantDefinition(w, h) {
        variants = variants.filter(v => !(v.width === w && v.height === h));
        renderVariantConfig();
        renderTopBar();
    }

    function renderVariantConfig() {
        // Lista w sekcji 2 (do usuwania)
        const c = document.getElementById('variantConfigList');
        c.innerHTML = '';
        variants.forEach(v => {
            const tag = document.createElement('div');
            tag.className = 'variant-tag';
            tag.innerHTML = `${v.width}√ó${v.height} cm <span onclick="removeVariantDefinition(${v.width}, ${v.height})">&times;</span>`;
            c.appendChild(tag);
        });
    }

    function renderTopBar() {
        // Przyciski w Top Bar (do u≈ºywania)
        const c = document.getElementById('topVariantsButtons');
        c.innerHTML = '';
        variants.forEach(v => {
            const btn = document.createElement('button');
            btn.className = 'panel-btn';
            btn.innerHTML = `+ ${v.width}√ó${v.height}`;
            btn.onmouseenter = () => {
                selectedPanelSize = {width: v.width, height: v.height};
                draw();
            };
            btn.onmouseleave = () => {
                selectedPanelSize = null;
                draw();
            };
            btn.onclick = () => {
                selectedPanelSize = null;
                addPanel(v.width, v.height);
            };
            c.appendChild(btn);
        });
    }

    function toggleLayoutMode() {
        layoutMode = layoutMode === 'horizontal' ? 'vertical' : 'horizontal';
        const btn = document.getElementById('modeToggleBtn');
        btn.innerHTML = layoutMode === 'horizontal' ? '‚û° Dodaj poziomo' : '‚¨Ü Dodaj pionowo';
    }

    // --- 2. NARZƒòDZIA (LEFT VERTICAL BAR) ---
    function renderToolsBar() {
        const c = document.getElementById('toolsBar');
        c.innerHTML = '';

        // 1. Gumka
        const eraser = document.createElement('div');
        eraser.className = `tool-btn eraser ${activeTool==='eraser'?'active':''}`;
        eraser.title = "Usu≈Ñ Panel (Kliknij panel aby usunƒÖƒá)";
        eraser.onclick = () => setActiveTool('eraser');
        c.appendChild(eraser);

        c.appendChild(document.createElement('div')).className = 'tool-sep';

        // 2. Kolory
        visualPalette.forEach(item => {
            const el = document.createElement('div');
            const isActive = activeTool.type === 'color' && activeTool.value === item.hex;
            el.className = `tool-btn ${isActive?'active':''}`;
            el.style.backgroundColor = item.hex;
            el.title = item.name;
            el.onclick = () => setActiveTool({ type: 'color', value: item.hex });
            c.appendChild(el);
        });

        c.appendChild(document.createElement('div')).className = 'tool-sep';

        // 3. Tekstury
        visualTextures.forEach(item => {
            const el = document.createElement('div');
            const isActive = activeTool.type === 'image' && activeTool.value === item.file;
            el.className = `tool-btn ${isActive?'active':''}`;
            el.style.backgroundImage = `url('${item.file}')`;
            el.title = item.name;
            el.onclick = () => setActiveTool({ type: 'image', value: item.file });
            c.appendChild(el);
        });
    }

    function setActiveTool(tool) {
        activeTool = tool;
        renderToolsBar(); // Od≈õwie≈º ramki
    }

    // --- 3. INTERAKCJA Z PROJEKTEM ---

    // Sprawdza wysoko≈õƒá obszaru roboczego w danym punkcie X
    function getHeightAtPosition(x) {
        if (wallData.segments.length === 0) return 0;

        let currentX = 50;
        let currentHeight = 0;

        for (let i = 0; i < wallData.segments.length; i++) {
            const seg = wallData.segments[i];
            const segStart = currentX;
            const segEnd = currentX + seg.width;

            if (x >= segStart && x < segEnd) {
                // X jest w tym segmencie - interpoluj wysoko≈õƒá
                const ratio = (x - segStart) / seg.width;
                return seg.startHeight + ratio * (seg.endHeight - seg.startHeight);
            }

            if (x >= segEnd && i === wallData.segments.length - 1) {
                // X jest za ostatnim segmentem
                return seg.endHeight;
            }

            currentX += seg.width;
        }

        return 0;
    }

    // Sprawdza czy panel mie≈õci siƒô w obszarze roboczym
    function checkPanelFits(x, y, width, height) {
        if (wallData.segments.length === 0) return true;

        // Sprawd≈∫ czy panel nie wychodzi poza szeroko≈õƒá obszaru
        let totalWidth = 50; // startX
        wallData.segments.forEach(s => totalWidth += s.width);

        if (x + width > totalWidth + 50) return false;

        // Sprawd≈∫ czy panel nie wychodzi ponad wysoko≈õƒá w ka≈ºdym punkcie
        const samples = 5; // Sprawd≈∫ w 5 punktach szeroko≈õci panelu
        for (let i = 0; i <= samples; i++) {
            const sampleX = x + (width * i / samples);
            const maxHeight = getHeightAtPosition(sampleX);
            if (y + height > maxHeight) return false;
        }

        return true;
    }

    // Znajduje nastƒôpnƒÖ mo≈ºliwƒÖ pozycjƒô dla panelu
    function findNextValidPosition(width, height) {
        if (wallData.segments.length === 0) {
            return { x: 50, y: 0, mode: 'horizontal', fits: false };
        }

        // Zacznij od pozycji bazowej
        let x = 50, y = 0;

        if (panels.length > 0) {
            const lastPanel = panels[panels.length - 1];

            if (layoutMode === 'horizontal') {
                x = lastPanel.x + lastPanel.width;
                y = 0;
            } else {
                x = lastPanel.x;
                y = lastPanel.y + lastPanel.height;
            }
        }

        // Sprawd≈∫ czy pasuje w bie≈ºƒÖcym trybie
        if (checkPanelFits(x, y, width, height)) {
            return { x, y, mode: layoutMode, fits: true };
        }

        // Je≈õli nie pasuje, spr√≥buj drugi tryb
        const altMode = layoutMode === 'horizontal' ? 'vertical' : 'horizontal';

        if (panels.length > 0) {
            const lastPanel = panels[panels.length - 1];

            if (altMode === 'horizontal') {
                x = lastPanel.x + lastPanel.width;
                y = 0;
            } else {
                x = lastPanel.x;
                y = lastPanel.y + lastPanel.height;
            }
        }

        if (checkPanelFits(x, y, width, height)) {
            return { x, y, mode: altMode, fits: true };
        }

        // Nic nie pasuje
        return { x, y, mode: layoutMode, fits: false };
    }

    function addPanel(width, height) {
        // Nowy panel otrzymuje styl z aktywnego narzƒôdzia (je≈õli to nie gumka)
        let style = { type: 'color', value: '#cccccc' }; // Default
        if (activeTool !== 'eraser') style = { ...activeTool };

        // Znajd≈∫ nastƒôpnƒÖ mo≈ºliwƒÖ pozycjƒô
        const nextPos = findNextValidPosition(width, height);

        if (!nextPos.fits) {
            alert('Panel nie mie≈õci siƒô w obszarze roboczym!\nWybierz mniejszy panel lub zmie≈Ñ tryb uk≈Çadania.');
            return;
        }

        // Je≈õli tryb siƒô zmieni≈Ç automatycznie, zaktualizuj UI
        if (nextPos.mode !== layoutMode) {
            layoutMode = nextPos.mode;
            const btn = document.getElementById('modeToggleBtn');
            btn.innerHTML = layoutMode === 'horizontal' ? '‚û° Dodaj poziomo' : '‚¨Ü Dodaj pionowo';
        }

        panels.push({ width, height, x: nextPos.x, y: nextPos.y, style });

        // Zapamiƒôtaj rozmiar dla auto-preview
        lastUsedPanelSize = { width, height };

        draw();
        updateMappingUI();
    }

    function onPanelClick(index) {
        if (activeTool === 'eraser') {
            panels.splice(index, 1); // USU≈É
        } else {
            panels[index].style = { ...activeTool }; // MALUJ
        }
        draw();
        updateMappingUI();
    }

    function undoPanel() { panels.pop(); draw(); updateMappingUI(); }

    // --- 4. ZAPIS (FIFO) ---
    function saveCurrentLayout() {
        let saves = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        saves.unshift({
            id: Date.now(),
            date: new Date().toLocaleTimeString(),
            wall: wallData,
            panels: panels,
            variants: variants,
            mapping: styleMapping,
            mode: layoutMode
        });
        if(saves.length > 5) saves.pop();
        localStorage.setItem(STORAGE_KEY, JSON.stringify(saves));
        renderSaves();
    }

    function renderSaves() {
        const c = document.getElementById('savesContainer');
        c.innerHTML = '';
        const saves = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        if(saves.length===0) c.innerHTML='<div style="color:#999; font-size:0.8em;">Pusto</div>';

        saves.forEach(s => {
            const d = document.createElement('div'); d.className='save-slot';
            d.innerHTML = `<span>${s.date} (${s.panels.length} el.)</span>
                <button class="btn-secondary" style="padding:2px 5px; font-size:0.8em;" onclick="loadSave(${s.id})">Wczytaj</button>`;
            c.appendChild(d);
        });
    }

    function loadSave(id) {
        const s = JSON.parse(localStorage.getItem(STORAGE_KEY)).find(x=>x.id===id);
        if(s && confirm("Wczytaƒá projekt?")) {
            wallData = s.wall;
            panels = s.panels;
            variants = s.variants || variants;
            styleMapping = s.mapping || {};
            layoutMode = s.mode || 'horizontal';

            const btn = document.getElementById('modeToggleBtn');
            btn.innerHTML = layoutMode === 'horizontal' ? '‚û° Dodaj poziomo' : '‚¨Ü Dodaj pionowo';

            draw();
            renderSegmentsList();
            renderVariantConfig();
            renderTopBar();
            updateMappingUI();
        }
    }

    // --- 5. LOGIKA OBSZARU ROBOCZEGO ---
    function loadPresetWorkspace() {
        wallData.segments = [
            {width: 60, startHeight: 140, endHeight: 140},
            {width: 200, startHeight: 140, endHeight: 140},
            {width: 60, startHeight: 140, endHeight: 140},
            {width: 100, startHeight: 140, endHeight: 80}
        ];
        renderSegmentsList();
        draw();
        updateMappingUI();
    }

    function addSegment() {
        const w = parseFloat(document.getElementById('segWidth').value);
        const sh = parseFloat(document.getElementById('segStartHeight').value);
        const eh = parseFloat(document.getElementById('segEndHeight').value);

        // Walidacja: sprawd≈∫ czy wszystkie pola sƒÖ wype≈Çnione
        if (!w || !sh || !eh || w <= 0 || sh <= 0 || eh <= 0) {
            alert('Wype≈Çnij wszystkie pola (szeroko≈õƒá, wysoko≈õƒá poczƒÖtkowa i ko≈Ñcowa) warto≈õciami wiƒôkszymi od 0');
            return;
        }

        wallData.segments.push({width: w, startHeight: sh, endHeight: eh});
        document.getElementById('segWidth').value = '';
        document.getElementById('segEndHeight').value = '';

        // Auto-wype≈Çnianie: przepisz wysoko≈õƒá ko≈ÑcowƒÖ do pola poczƒÖtkowej
        document.getElementById('segStartHeight').value = eh;

        renderSegmentsList();
        draw();
        updateMappingUI();
    }

    function removeSegment(i) {
        wallData.segments.splice(i, 1);
        renderSegmentsList();
        draw();
        updateMappingUI();
    }

    function resetWall() {
        if(confirm("Resetowaƒá obszar roboczy?")) {
            wallData.segments = [];
            document.getElementById('segStartHeight').value = '';
            document.getElementById('segEndHeight').value = '';
            renderSegmentsList();
            draw();
            updateMappingUI();
        }
    }

    function renderSegmentsList() {
        const c = document.getElementById('segmentsContainer');
        c.innerHTML = '';

        wallData.segments.forEach((s, i) => {
            // Okre≈õl ikonƒô kszta≈Çtu: prostokƒÖt (‚ñ≠) lub trapez (‚è¢)
            const shapeIcon = s.startHeight === s.endHeight ? '‚ñ≠' : '‚è¢';

            c.innerHTML += `<div class="segment-row">
                <span><span class="segment-icon" title="${s.startHeight === s.endHeight ? 'ProstokƒÖt' : 'Trapez'}">${shapeIcon}</span>${i+1}. <b>${s.width}</b>cm | ${s.startHeight}cm ‚Üí ${s.endHeight}cm</span>
                <button class="btn-x" onclick="removeSegment(${i})">X</button>
            </div>`;
        });
    }

    // --- 6. WYCENA & MAPOWANIE ---
    function updateMappingUI() {
        const used = [...new Set(panels.map(p=>p.style.value))];
        const c = document.getElementById('mappingContainer'); c.innerHTML='';
        if(used.length===0) { c.innerHTML='<div style="color:#999; font-size:0.8em;">Brak paneli</div>'; recalculatePrice(); return; }

        used.forEach(val => {
            const row = document.createElement('div'); row.className='mapping-item';
            const sw = document.createElement('div'); sw.className='map-swatch';
            if(val.includes('data:image')) { sw.style.backgroundImage=`url('${val}')`; sw.style.backgroundSize='cover'; }
            else sw.style.backgroundColor=val;

            const sel = document.createElement('select'); sel.className='map-select';
            sel.onchange = (e) => { styleMapping[val]=e.target.value; recalculatePrice(); };

            ['Standard','Premium','Exclusive'].forEach(grp => {
                const g = document.createElement('optgroup'); g.label=grp;
                Collections[grp].forEach(col => {
                    const o = document.createElement('option'); o.value=col; o.text=col;
                    if(styleMapping[val]===col) o.selected=true;
                    g.appendChild(o);
                });
                sel.appendChild(g);
            });
            if(!styleMapping[val]) { styleMapping[val]=Collections.Standard[0]; sel.value=Collections.Standard[0]; }

            row.appendChild(sw); row.appendChild(sel); c.appendChild(row);
        });
        recalculatePrice();
    }

    function recalculatePrice() {
        let total = 0, area = 0;
        const opts = {
            foam: document.getElementById('optFoam').checked,
            velcro: document.getElementById('optVelcro').checked,
            glue: parseInt(document.getElementById('optGlue').value)||0,
            shipping: document.getElementById('optShipping').checked
        };

        panels.forEach(p => {
            const col = styleMapping[p.style.value] || 'DIANA';
            let category = 'Standard';
            if (Collections.Premium.includes(col)) category = 'Premium';
            if (Collections.Exclusive.includes(col)) category = 'Exclusive';

            // Pobierz cenƒô z cennika (rozmiary.js)
            const key = `${p.width}x${p.height}`;
            let base = 0;

            if (category === 'Standard' && RozmStandard[key]) {
                base = RozmStandard[key];
            } else if (category === 'Premium' && RozmPremium[key]) {
                base = RozmPremium[key];
            } else if (category === 'Exclusive' && RozmExclusive[key]) {
                base = RozmExclusive[key];
            } else {
                // Fallback: cena za m¬≤ (300 z≈Ç/m¬≤)
                base = ((p.width * p.height) / 10000) * 300;
            }

            let extra = 0;
            const m2 = (p.width * p.height) / 10000;
            if(opts.foam) extra += (m2 < 0.4 ? 6 : 15);
            if(opts.velcro) extra += (m2 < 0.4 ? 8 : 20);

            total += base + extra;
            area += m2;
        });

        total += opts.glue * 36;
        if(opts.shipping && panels.length > 0) total += 39;

        document.getElementById('totalPriceDisplay').innerText = total.toFixed(2) + " z≈Ç";
        document.getElementById('priceDetails').innerHTML = `Pow: ${area.toFixed(2)} m¬≤ | Paneli: ${panels.length}`;
    }

    // --- 7. WIZUALIZACJA ---
    function draw() {
        const svg = document.getElementById('svgWrapper');

        if (wallData.segments.length === 0) {
            // Brak segment√≥w - poka≈º pustƒÖ przestrze≈Ñ
            svg.innerHTML = `<svg width="300px" viewBox="0 0 300 200">
                <text x="150" y="100" text-anchor="middle" fill="#999" font-size="14">
                    Dodaj segmenty obszaru
                </text>
            </svg>`;
            return;
        }

        let totalW = 0, maxH = 0;
        wallData.segments.forEach(s => {
            totalW += s.width;
            maxH = Math.max(maxH, s.startHeight, s.endHeight);
        });

        const padX = 50, padY = 60;
        const W = totalW + padX * 2, H = maxH + padY * 2;
        const startX = padX, floorY = H - padY;

        // Budowanie ≈õcie≈ºki obszaru roboczego
        let cx = startX;
        let d = `M ${cx} ${floorY}`;

        // Linia g√≥rna (od lewej do prawej)
        wallData.segments.forEach(s => {
            d += ` L ${cx} ${floorY - s.startHeight}`;
            cx += s.width;
            d += ` L ${cx} ${floorY - s.endHeight}`;
        });

        // Zamkniƒôcie ≈õcie≈ºki (prawa krawƒôd≈∫ w d√≥≈Ç, linia dolna)
        d += ` L ${cx} ${floorY} Z`;

        let defs = `<clipPath id="wc"><path d="${d}"/></clipPath>`;
        const uTex = [...new Set(panels.filter(p=>p.style.type==='image').map(p=>p.style.value))];
        uTex.forEach((src,i)=> defs+=`<pattern id="pt${i}" patternUnits="userSpaceOnUse" width="50" height="50"><image href="${src}" x="0" y="0" width="50" height="50" preserveAspectRatio="xMidYMid slice"/></pattern>`);

        // Dodaj wzory overflow do defs
        panels.forEach((p, i) => {
            const fits = checkPanelFits(p.x, p.y, p.width, p.height);
            if (!fits) {
                defs += `<pattern id="ovf${i}" patternUnits="userSpaceOnUse" width="10" height="10" patternTransform="rotate(45)">
                    <line x1="0" y1="0" x2="0" y2="10" stroke="#dc3545" stroke-width="2"/>
                </pattern>`;
            }
        });

        const pSvg = panels.map((p,i)=>{
            const fill = p.style.type==='color' ? p.style.value : `url(#pt${uTex.indexOf(p.style.value)})`;
            const cls = activeTool==='eraser' ? 'panel-rect delete-mode' : 'panel-rect';

            // Pozycja panelu (x,y od lewego dolnego rogu)
            const panelX = p.x;
            const panelY = floorY - p.y - p.height;

            // Sprawd≈∫ czy panel wystaje poza obszar
            const fits = checkPanelFits(p.x, p.y, p.width, p.height);

            // Wymiary WEWNƒÑTRZ panelu
            // Szeroko≈õƒá - poziomo na dole
            const widthTextY = panelY + p.height - 8;
            // Wysoko≈õƒá - pionowo (obr√≥cona 90¬∞) po prawej stronie
            const heightTextX = panelX + p.width - 8;
            const heightTextY = panelY + p.height/2;

            return `<g onclick="onPanelClick(${i})">
                <rect x="${panelX}" y="${panelY}" width="${p.width}" height="${p.height}" fill="${fill}" class="${cls}"/>
                ${fits ? '' : `<rect x="${panelX}" y="${panelY}" width="${p.width}" height="${p.height}" fill="url(#ovf${i})" opacity="0.4" pointer-events="none"/>`}
                <text x="${panelX + p.width/2}" y="${widthTextY}" text-anchor="middle" class="dim-text-panel">${p.width}</text>
                <text x="${heightTextX}" y="${heightTextY}" text-anchor="middle" class="dim-text-panel" transform="rotate(-90 ${heightTextX} ${heightTextY})">${p.height}</text>
                <line x1="${panelX}" y1="${panelY}" x2="${panelX}" y2="${panelY + p.height}" stroke="rgba(0,0,0,0.15)" stroke-width="1"/>
                <line x1="${panelX + p.width}" y1="${panelY}" x2="${panelX + p.width}" y2="${panelY + p.height}" stroke="rgba(0,0,0,0.15)" stroke-width="1"/>
            </g>`;
        }).join('');

        // Preview nastƒôpnego panelu (hover ma priorytet, potem auto-preview)
        let previewSVG = '';
        const previewSize = selectedPanelSize || lastUsedPanelSize; // Hover lub ostatnio u≈ºyty

        if (previewSize) {
            const nextPos = findNextValidPosition(previewSize.width, previewSize.height);
            if (nextPos.fits) {
                const prevX = nextPos.x;
                const prevY = floorY - nextPos.y - previewSize.height;

                // Kolor: zielony dla hover, niebieski dla auto-preview
                const isHover = selectedPanelSize !== null;
                const strokeColor = isHover ? '#28a745' : '#007bff';
                const fillColor = isHover ? 'rgba(40, 167, 69, 0.2)' : 'rgba(0, 123, 255, 0.15)';

                // Prze≈∫roczysty prostokƒÖt
                previewSVG += `<rect x="${prevX}" y="${prevY}" width="${previewSize.width}" height="${previewSize.height}"
                    fill="${fillColor}" stroke="${strokeColor}" stroke-width="2" stroke-dasharray="5,5" pointer-events="none"/>`;

                // Strza≈Çka wskazujƒÖca lewy dolny r√≥g
                const arrowX = prevX - 15;
                const arrowY = prevY + previewSize.height + 15;
                previewSVG += `<path d="M ${arrowX} ${arrowY - 10} L ${arrowX} ${arrowY} L ${arrowX + 10} ${arrowY}"
                    fill="none" stroke="${strokeColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>`;
                previewSVG += `<path d="M ${arrowX} ${arrowY} L ${prevX} ${prevY + previewSize.height}"
                    stroke="${strokeColor}" stroke-width="1.5" stroke-dasharray="3,3"/>`;
            }
        }

        // Wymiarowanie segment√≥w (wysoko≈õci)
        let dimensionsSVG = '';
        let segX = startX;
        wallData.segments.forEach((s, idx) => {
            const topYStart = floorY - s.startHeight;
            const topYEnd = floorY - s.endHeight;

            // Linia wymiarowa na poczƒÖtku segmentu
            dimensionsSVG += `<line x1="${segX}" y1="${floorY}" x2="${segX}" y2="${topYStart - 10}" class="dim-line" stroke="#888" />`;
            dimensionsSVG += `<text x="${segX + 5}" y="${topYStart - 15}" text-anchor="start" class="dim-text-external" font-weight="bold">${s.startHeight}</text>`;

            // Wymiar szeroko≈õci segmentu (na dole)
            const segMidX = segX + s.width / 2;
            const dimY = floorY + 30;
            dimensionsSVG += `<line x1="${segX}" y1="${dimY}" x2="${segX + s.width}" y2="${dimY}" stroke="#444" stroke-width="1" />`;
            dimensionsSVG += `<line x1="${segX}" y1="${dimY-5}" x2="${segX}" y2="${dimY+5}" stroke="#444" stroke-width="1" />`;
            dimensionsSVG += `<line x1="${segX + s.width}" y1="${dimY-5}" x2="${segX + s.width}" y2="${dimY+5}" stroke="#444" stroke-width="1" />`;
            dimensionsSVG += `<text x="${segMidX}" y="${dimY + 15}" text-anchor="middle" class="dim-text-external" font-size="12" font-weight="bold">${s.width}</text>`;

            segX += s.width;

            // Linia wymiarowa na ko≈Ñcu ostatniego segmentu
            if (idx === wallData.segments.length - 1) {
                dimensionsSVG += `<line x1="${segX}" y1="${floorY}" x2="${segX}" y2="${topYEnd - 10}" class="dim-line" stroke="#888" />`;
                dimensionsSVG += `<text x="${segX - 5}" y="${topYEnd - 15}" text-anchor="end" class="dim-text-external" font-weight="bold">${s.endHeight}</text>`;
            }
        });

        svg.innerHTML = `<svg width="${W*zoomLevel}px" viewBox="0 0 ${W} ${H}">
            <defs>${defs}</defs>
            <path d="${d}" class="wall-bg"/>
            ${pSvg}
            ${previewSVG}
            <path d="${d}" fill="none" stroke="#555" stroke-width="2"/>
            ${dimensionsSVG}
        </svg>`;
    }

    function changeZoom(d) {
        zoomLevel = Math.max(0.2, Math.min(3.0, zoomLevel + d));
        document.getElementById('zoomLabel').innerText = Math.round(zoomLevel*100)+'%';
        draw();
    }
</script>

</body>
</html>
